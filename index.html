<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HCMS</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HCMS">
    <link rel="apple-touch-icon" href="logo.png">
    
    <link rel="manifest" id="manifest-placeholder">

    <link rel="icon" type="image/png" href="logo.png">

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // [PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±ê¸°] HTML ì‹¤í–‰ ì‹œ ì¦‰ì„ì—ì„œ ì•± ì •ë³´ë¥¼ ë§Œë“­ë‹ˆë‹¤.
        const manifest = {
            "name": "ëª¨ì ì›ê°€ ê´€ë¦¬ ì‹œìŠ¤í…œ (HCMS)",
            "short_name": "HCMS",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#1a237e",
            "theme_color": "#1a237e",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "logo.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "logo.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <style>
        /* ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
        :root { --primary: #1a237e; --accent: #3949ab; --bg: #f4f6f9; --border: #e1e4e8; --text: #333; --danger: #d32f2f; --sidebar-width: 280px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; font-size: 13.5px; padding-top: 60px; }
        
        /* ì„¤ì¹˜ ë²„íŠ¼ (PWA ì „ìš©) */
        #installBtn {
            display: none; width: 100%; background: #333; color: white; padding: 15px;
            position: fixed; bottom: 0; left: 0; z-index: 9999; text-align: center; cursor: pointer;
            font-weight: bold; font-size: 1rem;
        }

        /* (ì´í•˜ ê¸°ì¡´ CSS ì „ì²´ í¬í•¨) */
        #loginScreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--primary); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { text-align: center; padding: 30px; background: white; border-radius: 15px; width: 90%; max-width: 350px; color: #333; }
        .google-btn { background: #4285F4; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; }
        .user-profile { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #666; margin-right: 10px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; }
        .app-header { position: fixed; top: 0; left: 0; right: 0; height: 55px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { font-size: 1.4rem; color: var(--primary); cursor: pointer; border: none; background: none; padding: 5px; }
        .app-title { font-weight: 700; font-size: 1.1rem; color: var(--primary); margin: 0; }
        .header-logo { width: 30px; height: 30px; border-radius: 6px; object-fit: cover; }
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-width); background: white; z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { padding: 15px; overflow-y: auto; flex: 1; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        h3 { font-size: 0.95rem; color: #555; margin: 5px 0 12px 0; border-left: 4px solid var(--accent); padding-left: 10px; font-weight: 600; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group { flex: 1; margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; background: #fff; -webkit-appearance: none; }
        input:focus { outline: none; border-color: var(--accent); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 300px; margin-bottom: 5px; }
        th { background: #f8f9fa; font-size: 0.8rem; color: #666; padding: 8px; border: 1px solid var(--border); text-align: center; }
        td { border: 1px solid var(--border); padding: 0; }
        td input { border: none; text-align: center; padding: 8px; font-size: 0.9rem; }
        .del-btn { color: #aaa; background: none; border: none; font-size: 1.1rem; padding: 0 10px; }
        .del-btn:hover { color: var(--danger); }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #555; padding: 8px; font-size: 0.85rem; width: auto; }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; margin-top: 0; }
        .result-box { background: var(--primary); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px; box-shadow: 0 4px 10px rgba(26, 35, 126, 0.2); }
        .result-box h1 { font-size: 2rem; margin: 5px 0 0 0; }
        .result-box p { font-size: 0.9rem; opacity: 0.9; margin: 5px 0 0 0; }
        .detail-table { margin-top: 15px; font-size: 0.9rem; }
        .detail-table th { text-align: left; padding-left: 10px; background: white; border: none; border-bottom: 1px solid #eee; }
        .detail-table td { text-align: right; padding-right: 10px; border: none; border-bottom: 1px solid #eee; font-weight: 500; }
        .project-item { background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 8px; position: relative; }
        .project-item h4 { margin: 0 0 4px 0; font-size: 0.9rem; color: var(--primary); }
        .project-item p { margin: 0; font-size: 0.75rem; color: #888; }
        .project-actions { margin-top: 8px; display: flex; gap: 5px; }
        .scrap-item { background: white; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .scrap-info { font-size: 0.85rem; }
        .scrap-price { font-weight: bold; color: var(--primary); }
        .text-right { text-align: right; }
        .bold { font-weight: 600; }
        .text-primary { color: var(--primary); }
    </style>
</head>
<body>

    <div id="installBtn">ğŸ“² ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸° (í´ë¦­)</div>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" alt="logo" style="width:60px; height:60px; border-radius:12px; margin-bottom:15px;" onerror="this.style.display='none'">
            <h2>HCMS Cloud</h2>
            <p style="font-size:0.9rem; color:#666;">PC â†” ëª¨ë°”ì¼ ì‹¤ì‹œê°„ ì—°ë™</p>
            <button class="google-btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <div id="app" style="display:none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <img src="logo.png" class="header-logo" onerror="this.style.display='none'">
                <h1 class="app-title">HCMS</h1>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="user-profile">
                    <img id="userAvatar" class="user-avatar" src="">
                </div>
                <button onclick="saveInputSet()" style="background:none; border:none; color:var(--primary); font-weight:bold; font-size:0.9rem;">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
            </div>
        </header>

        <div class="overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’¾ í´ë¼ìš°ë“œ í”„ë¡œì íŠ¸</h2>
                <i class="fas fa-times close-btn" onclick="toggleSidebar()"></i>
            </div>
            <div class="sidebar-content">
                <button class="btn btn-primary" onclick="saveInputSet()" style="margin-bottom:15px;">
                    <i class="fas fa-cloud-upload-alt"></i> í˜„ì¬ ì‘ì—… ì €ì¥
                </button>
                <div id="projectListContainer">
                    <p style="text-align:center; color:#999; font-size:0.8rem; margin-top:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                <button class="btn btn-outline" style="color:#666;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <h3>ê¸°ë³¸ ì •ë³´</h3>
                <div class="input-group">
                    <label>ìƒí’ˆëª…</label>
                    <input type="text" id="productName" value="2026 SS ì‹œê·¸ë‹ˆì²˜ ë³¼ìº¡">
                </div>
                <div class="input-group">
                    <label>ìƒì‚° ìˆ˜ëŸ‰ (MOQ)</label>
                    <input type="number" id="qty" value="100" inputmode="numeric" oninput="calculate()">
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>ì›ìì¬ (BOM)</h3>
                    <button class="btn btn-outline btn-sm" onclick="addMaterialRow()">+ ì¶”ê°€</button>
                </div>
                <div class="table-wrapper">
                    <table id="bomTable">
                        <thead><tr><th style="text-align:left; padding-left:10px;">ìì¬ëª…</th><th width="60">ë‹¨ê°€</th><th width="45">ìš”ì²™</th><th width="30"></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="text-right bold text-primary" style="font-size:0.85rem; margin-top:5px;">
                    ìì¬ë¹„ í•©ê³„: <span id="matSumDisplay">0</span>ì›
                </div>
            </div>

            <div class="card">
                <h3>ê³µì„ ë° ê³ ì •ë¹„</h3>
                <div class="input-row">
                    <div class="input-group"><label>ë´‰ì œ</label><input type="number" class="labor-input" value="6000" inputmode="numeric" oninput="calculate()"></div>
                    <div class="input-group"><label>ììˆ˜/ë‚˜ì—¼</label><input type="number" class="labor-input" value="1500" inputmode="numeric" oninput="calculate()"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>ë§ˆê°/í¬ì¥</label><input type="number" class="labor-input" value="500" inputmode="numeric" oninput="calculate()"></div>
                    <div class="input-group"><label>ë¬¼ë¥˜/ê¸°íƒ€</label><input type="number" class="labor-input" value="300" inputmode="numeric" oninput="calculate()"></div>
                </div>
                <div class="input-group"><label>íŒ¨í„´/ìƒ˜í”Œë¹„ (ì „ì²´ 1/N)</label><input type="number" id="fixedCost" value="300000" inputmode="numeric" oninput="calculate()"></div>
                <div class="text-right bold text-primary" style="font-size:0.85rem;">ê³µì„ í•©ê³„: <span id="laborSumDisplay">0</span>ì›</div>
            </div>

            <div class="card">
                <h3>ê°€ê²© ì±…ì •</h3>
                <div class="input-group">
                    <label>íŒë§¤ í¬ë§ê°€</label>
                    <input type="number" id="targetPrice" value="49000" inputmode="numeric" oninput="calculate()" style="font-weight:bold; color:var(--primary);">
                    <div id="multiplierDisplay" style="font-size:0.8rem; color:#666; margin-top:4px;">ğŸ“Š ì›ê°€ ëŒ€ë¹„ 0.0ë°°ìˆ˜</div>
                </div>
                <label>íŒë§¤ ì±„ë„</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="channel" onchange="calculate()" style="flex:1;"></select>
                    <button class="btn btn-outline btn-sm" onclick="addChannel()">+</button>
                    <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger);" onclick="deleteChannel()">-</button>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                    <input type="checkbox" id="vatOn" checked onchange="calculate()" style="width:20px; height:20px; margin-right:8px; flex:none;">
                    <label for="vatOn" style="margin:0;">VAT í¬í•¨</label>
                </div>
                <div class="result-box">
                    <h2>ì˜ˆìƒ ìˆœì´ìµ</h2>
                    <h1 id="netProfit">0ì›</h1>
                    <p id="marginRate">ë§ˆì§„ìœ¨ 0.0%</p>
                </div>
                <table class="detail-table">
                    <tr><th>íŒë§¤ê°€</th><td id="t_price">0ì›</td></tr>
                    <tr><th>(-) ì œì¡°ì›ê°€</th><td id="t_cost" style="color:var(--danger);">0ì›</td></tr>
                    <tr><th>(-) ìˆ˜ìˆ˜ë£Œ</th><td id="t_fee" style="color:var(--danger);">0ì›</td></tr>
                    <tr><th>(-) ë¶€ê°€ì„¸</th><td id="t_vat" style="color:var(--danger);">0ì›</td></tr>
                </table>
                <button class="btn btn-primary" onclick="saveResultToScrap()" style="margin-top:15px;">
                    <i class="fas fa-thumbtack"></i> ê²°ê³¼ ìŠ¤í¬ë©
                </button>
            </div>

            <div class="card" id="scrapSection">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>ìŠ¤í¬ë© ë¦¬ìŠ¤íŠ¸</h3>
                    <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:#eee;" onclick="clearScrapData()">ë¹„ìš°ê¸°</button>
                </div>
                <div id="scrapListContainer"></div>
                <button class="btn btn-outline" style="margin-top:10px; width:100%;" onclick="downloadExcel()">
                    <i class="fas fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
            <div style="height:30px;"></div>
        </div>
    </div>

    <script>
        // ###############################################################
        // [ì„¤ì • 1] ì—¬ê¸°ì— Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ Config ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        // ###############################################################
        const firebaseConfig = {
            apiKey: "ì—¬ê¸°ì—_API_KEY_ë¶™ì—¬ë„£ê¸°",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        // ###############################################################

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // PWA ì„¤ì¹˜ ë²„íŠ¼ ë¡œì§
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.style.display = 'block';
            btn.addEventListener('click', () => {
                btn.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            });
        });

        // ì¸ì¦ ìƒíƒœ ê°ì§€
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userAvatar').src = user.photoURL;
                startSync();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(() => auth.signInWithRedirect(provider));
        }

        function logout() { auth.signOut(); location.reload(); }

        // ë™ê¸°í™” ë³€ìˆ˜
        let projects = [];
        let scrapList = [];
        let customChannels = [];
        const defaultMaterials = [
            {name: "ê²‰ê°", price: 4500, yield: 0.3}, {name: "ì±™ì‹¬", price: 500, yield: 1.0},
            {name: "ë•€ë°›ì´", price: 800, yield: 1.0}, {name: "íƒ‘ë²„íŠ¼/ì•„ì¼ë ›", price: 150, yield: 1.0},
            {name: "ë©”ì¸ ë¼ë²¨", price: 120, yield: 1.0}, {name: "ì¼€ì–´ ë¼ë²¨", price: 80, yield: 1.0},
            {name: "í´ë¦¬ë°±/ë°•ìŠ¤", price: 500, yield: 1.0}
        ];
        const defaultChannels = [
            {name: "ìì‚¬ëª° (3.5%)", rate: 0.035}, {name: "ë¬´ì‹ ì‚¬ (30%)", rate: 0.30},
            {name: "ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ (6%)", rate: 0.06}, {name: "ë°±í™”ì  (35%)", rate: 0.35}
        ];

        function startSync() {
            const uid = currentUser.uid;
            db.collection('users').doc(uid).collection('projects').orderBy('id', 'desc').onSnapshot(snapshot => {
                projects = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                renderProjectList();
            });
            db.collection('users').doc(uid).collection('scraps').orderBy('date', 'desc').onSnapshot(snapshot => {
                scrapList = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                renderScrapList();
            });
            db.collection('users').doc(uid).collection('settings').doc('channels').onSnapshot(doc => {
                if(doc.exists) customChannels = doc.data().list || [];
                renderChannelOptions();
                calculate();
            });
        }

        // ì €ì¥ ë¡œì§
        function saveInputSet() {
            if(!currentUser) return;
            const pName = document.getElementById("productName").value;
            const saveName = prompt("í”„ë¡œì íŠ¸ ì €ì¥ ì´ë¦„:", pName);
            if(!saveName) return;

            const materials = [];
            document.querySelectorAll("#bomTable tbody tr").forEach(row => {
                materials.push({
                    name: row.querySelector(".mat-name").value,
                    price: row.querySelector(".mat-price").value,
                    yield: row.querySelector(".mat-yield").value
                });
            });
            const laborCosts = [];
            document.querySelectorAll(".labor-input").forEach(input => laborCosts.push(input.value));

            const project = {
                id: Date.now(), title: saveName, productName: pName,
                qty: document.getElementById("qty").value,
                materials: materials, laborCosts: laborCosts,
                fixedCost: document.getElementById("fixedCost").value,
                targetPrice: document.getElementById("targetPrice").value,
                channelRate: document.getElementById("channel").value,
                vatOn: document.getElementById("vatOn").checked
            };
            db.collection('users').doc(currentUser.uid).collection('projects').add(project)
                .then(() => { alert("ì €ì¥ ì™„ë£Œ!"); toggleSidebar(); });
        }

        function deleteProject(fid, e) {
            e.stopPropagation();
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.collection('users').doc(currentUser.uid).collection('projects').doc(fid).delete();
        }

        function saveResultToScrap() {
            if(!currentUser) return;
            const sel = document.getElementById("channel");
            const item = {
                name: document.getElementById("productName").value,
                channel: sel.options[sel.selectedIndex].text,
                price: document.getElementById("targetPrice").value,
                profit: document.getElementById("netProfit").innerText,
                margin: document.getElementById("marginRate").innerText,
                date: new Date().toISOString()
            };
            db.collection('users').doc(currentUser.uid).collection('scraps').add(item)
                .then(() => { alert("ìŠ¤í¬ë© ì™„ë£Œ!"); document.getElementById("scrapSection").scrollIntoView({behavior:"smooth"}); });
        }

        function clearScrapData() {
            if(!confirm("ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const batch = db.batch();
            scrapList.forEach(item => {
                const ref = db.collection('users').doc(currentUser.uid).collection('scraps').doc(item.firebaseId);
                batch.delete(ref);
            });
            batch.commit();
        }

        function updateChannelsInCloud() {
            db.collection('users').doc(currentUser.uid).collection('settings').doc('channels').set({ list: customChannels });
        }
        function addChannel() {
            const name = prompt("ì±„ë„ëª…"); if(!name) return;
            const fee = prompt("ìˆ˜ìˆ˜ë£Œìœ¨ ìˆ«ìë§Œ"); if(!fee) return;
            customChannels.push({ name: `${name} (${fee}%)`, rate: Number(fee)/100 });
            updateChannelsInCloud();
        }
        function deleteChannel() {
            const select = document.getElementById("channel");
            const selectedText = select.options[select.selectedIndex].text;
            if(defaultChannels.some(c => c.name === selectedText)) { alert("ê¸°ë³¸ ì±„ë„ì€ ì‚­ì œ ë¶ˆê°€"); return; }
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                customChannels = customChannels.filter(c => c.name !== selectedText);
                updateChannelsInCloud();
            }
        }

        // ë Œë”ë§ í•¨ìˆ˜ë“¤
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }
        
        renderChannelOptions();
        defaultMaterials.forEach(m => addMaterialRow(m.name, m.price, m.yield));
        calculate();

        function addMaterialRow(name="", price=0, yieldVal=1.0) {
            const tbody = document.querySelector("#bomTable tbody");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td style="text-align:left;"><input type="text" class="mat-name" value="${name}" placeholder="ìì¬ëª…" style="text-align:left; padding-left:5px;"></td>
                <td><input type="number" class="mat-price" value="${price}" inputmode="numeric" oninput="calculate()"></td>
                <td><input type="number" class="mat-yield" value="${yieldVal}" inputmode="numeric" oninput="calculate()"></td>
                <td><button class="del-btn" onclick="deleteRow(this)">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            calculate();
        }
        function deleteRow(btn) { btn.closest("tr").remove(); calculate(); }

        function renderChannelOptions() {
            const select = document.getElementById("channel");
            const currentVal = select.value;
            select.innerHTML = "";
            [...defaultChannels, ...customChannels].forEach(ch => {
                const option = document.createElement("option");
                option.text = ch.name;
                option.value = ch.rate;
                select.add(option);
            });
            if(currentVal && [...select.options].some(o => o.value == currentVal)) select.value = currentVal;
            else select.selectedIndex = 0;
        }

        function renderProjectList() {
            const con = document.getElementById("projectListContainer");
            con.innerHTML = "";
            if(projects.length === 0) { con.innerHTML = "<p style='color:#999; font-size:0.8rem;'>ì €ì¥ëœ ë‚´ì—­ ì—†ìŒ</p>"; return; }
            projects.forEach(p => {
                const div = document.createElement("div");
                div.className = "project-item";
                div.onclick = () => loadProject(p);
                div.innerHTML = `
                    <h4>${p.title}</h4>
                    <p>${p.productName} / ${Number(p.targetPrice).toLocaleString()}ì›</p>
                    <div class="project-actions">
                        <button class="btn btn-outline btn-sm" style="flex:1;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:#eee;" onclick="deleteProject('${p.firebaseId}', event)">ì‚­ì œ</button>
                    </div>
                `;
                con.appendChild(div);
            });
        }

        function loadProject(p) {
            if(!confirm(`[${p.title}] ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            document.getElementById("productName").value = p.productName;
            document.getElementById("qty").value = p.qty;
            document.getElementById("fixedCost").value = p.fixedCost;
            document.getElementById("targetPrice").value = p.targetPrice;
            document.getElementById("channel").value = p.channelRate;
            document.getElementById("vatOn").checked = p.vatOn;
            
            const tbody = document.querySelector("#bomTable tbody");
            tbody.innerHTML = "";
            p.materials.forEach(m => addMaterialRow(m.name, m.price, m.yield));
            
            const laborInputs = document.querySelectorAll(".labor-input");
            p.laborCosts.forEach((val, idx) => { if(laborInputs[idx]) laborInputs[idx].value = val; });
            calculate();
            toggleSidebar();
        }

        function renderScrapList() {
            const con = document.getElementById("scrapListContainer");
            con.innerHTML = "";
            if(scrapList.length === 0) { con.innerHTML = "<p style='color:#ccc; text-align:center; font-size:0.8rem;'>ìŠ¤í¬ë© ë‚´ì—­ ì—†ìŒ</p>"; return; }
            scrapList.forEach(item => {
                const div = document.createElement("div");
                div.className = "scrap-item";
                div.innerHTML = `
                    <div class="scrap-info">
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="color:#888; font-size:0.75rem;">${item.channel}</div>
                    </div>
                    <div class="text-right">
                        <div class="scrap-price">${item.profit}</div>
                        <div style="font-size:0.75rem; color:#555;">${item.margin}</div>
                    </div>
                `;
                con.appendChild(div);
            });
        }

        function calculate() {
            let matSum = 0;
            document.querySelectorAll("#bomTable tbody tr").forEach(row => {
                matSum += (Number(row.querySelector(".mat-price").value)||0) * (Number(row.querySelector(".mat-yield").value)||0);
            });
            document.getElementById("matSumDisplay").innerText = Math.round(matSum).toLocaleString();
            let laborSum = 0;
            document.querySelectorAll(".labor-input").forEach(inp => laborSum += Number(inp.value));
            const qty = Number(document.getElementById("qty").value)||1;
            const fixed = Number(document.getElementById("fixedCost").value)/qty;
            const totalLabor = laborSum + fixed;
            document.getElementById("laborSumDisplay").innerText = Math.round(totalLabor).toLocaleString();
            const totalCOG = matSum + totalLabor;
            const target = Number(document.getElementById("targetPrice").value);
            const mul = totalCOG > 0 ? target/totalCOG : 0;
            document.getElementById("multiplierDisplay").innerText = `ğŸ“Š ì›ê°€(${Math.round(totalCOG).toLocaleString()}) ëŒ€ë¹„ ${mul.toFixed(1)}ë°°ìˆ˜`;
            const chRate = Number(document.getElementById("channel").value);
            const isVat = document.getElementById("vatOn").checked;
            const vat = isVat ? target - (target/1.1) : target*0.1;
            const fee = target * chRate;
            const profit = target - totalCOG - fee - vat;
            const margin = target > 0 ? (profit/target)*100 : 0;
            document.getElementById("netProfit").innerText = `${Math.round(profit).toLocaleString()}ì›`;
            document.getElementById("marginRate").innerText = `ë§ˆì§„ìœ¨ ${margin.toFixed(1)}%`;
            document.getElementById("t_price").innerText = target.toLocaleString() + "ì›";
            document.getElementById("t_cost").innerText = "-" + Math.round(totalCOG).toLocaleString() + "ì›";
            document.getElementById("t_fee").innerText = "-" + Math.round(fee).toLocaleString() + "ì›";
            document.getElementById("t_vat").innerText = "-" + Math.round(vat).toLocaleString() + "ì›";
        }

        function downloadExcel() {
            if(scrapList.length===0) { alert("ë°ì´í„° ì—†ìŒ"); return; }
            const ws = XLSX.utils.json_to_sheet(scrapList);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì›ê°€ë¦¬ìŠ¤íŠ¸");
            XLSX.writeFile(wb, `HCMS_Cloud_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>